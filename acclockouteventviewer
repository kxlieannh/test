<#
Robust account lockout collector (Event ID 4740)
- Parses EventData by Name instead of index
- Adds error handling and ensures output directory exists
- Allows filtering by username and domain, and optional DC list

Usage examples:
# 1) Run against all DCs (default) and filter for kylie.hall in int.sas-shoes.net
.\acclockouteventviewer.ps1 -FilterUser 'kylie.hall' -FilterDomain 'int.sas-shoes.net'

# 2) Run against a specific DC and filter
.\acclockouteventviewer.ps1 -FilterUser 'kylie.hall' -FilterDomain 'int.sas-shoes.net' -DCs 'dc01.int.sas-shoes.net'

Requirements:
- ActiveDirectory module
- Account with permission to read Security event logs on DCs (typically Domain Admin)
#>

param(
    [string]$FilterUser     = 'kylie.hall',
    [string]$FilterDomain   = 'int.sas-shoes.net',
    [string[]]$DCs          = @(),                  # optional: supply one or more DC hostnames to target
    [int]$HoursToLookBack   = 48,
    [string]$OutputCSV      = "C:\Temp\Lockout_Report.csv"
)

try {
    Import-Module ActiveDirectory -ErrorAction Stop
}
catch {
    Write-Error "ActiveDirectory module is required but could not be loaded: $($_.Exception.Message)"
    return
}

# Ensure output directory exists
$OutDir = Split-Path -Path $OutputCSV -Parent
if (-not (Test-Path -Path $OutDir)) {
    try { New-Item -Path $OutDir -ItemType Directory -Force | Out-Null }
    catch {
        Write-Error "Failed to create output directory '$OutDir': $($_.Exception.Message)"
        return
    }
}

# Gather DCs if none were supplied
if (-not $DCs -or $DCs.Count -eq 0) {
    try {
        $DCs = Get-ADDomainController -Filter * -ErrorAction Stop | Select-Object -ExpandProperty HostName
    }
    catch {
        Write-Error "Failed to enumerate domain controllers: $($_.Exception.Message)"
        return
    }
}

if (-not $DCs -or $DCs.Count -eq 0) {
    Write-Warning "No domain controllers found or supplied."
    return
}

Write-Host "Collecting lockout events from $($DCs.Count) domain controllers..." -ForegroundColor Cyan

$LockoutEvents = @()
$FilterUserNormalized = if ($FilterUser) { $FilterUser.ToLower() } else { $null }
$FilterDomainNormalized = if ($FilterDomain) { $FilterDomain.ToLower() } else { $null }

foreach ($DC in $DCs) {
    Write-Host "‚Üí Checking $DC..." -ForegroundColor Yellow
    try {
        $Events = Get-WinEvent -ComputerName $DC -FilterHashtable @{
            LogName   = 'Security';
            Id        = 4740;
            StartTime = (Get-Date).AddHours(-$HoursToLookBack)
        } -ErrorAction Stop

        foreach ($Event in $Events) {
            try {
                $xml = [xml]$Event.ToXml()
                $edata = @{}
                foreach ($d in $xml.Event.EventData.Data) {
                    if ($d.Name) { $edata[$d.Name] = $d.'#text' }
                }

                # Robust field extraction with fallbacks
                $User = $null
                if ($edata.ContainsKey('TargetUserName')) { $User = $edata['TargetUserName'] }
                elseif ($edata.ContainsKey('TargetUser')) { $User = $edata['TargetUser'] }
                elseif ($edata.ContainsKey('SubjectUserName')) { $User = $edata['SubjectUserName'] }

                $CallerComputer = $null
                if ($edata.ContainsKey('CallerComputerName')) { $CallerComputer = $edata['CallerComputerName'] }
                elseif ($edata.ContainsKey('CallerComputer')) { $CallerComputer = $edata['CallerComputer'] }

                $TargetDomain = $null
                if ($edata.ContainsKey('TargetDomainName')) { $TargetDomain = $edata['TargetDomainName'] }
                elseif ($edata.ContainsKey('TargetDomain')) { $TargetDomain = $edata['TargetDomain'] }

                # Apply filters if provided (case-insensitive)
                $keep = $true
                if ($FilterUserNormalized) {
                    if (-not $User) { $keep = $false }
                    else { $keep = ($User.ToLower() -eq $FilterUserNormalized) }
                }
                if ($keep -and $FilterDomainNormalized) {
                    if (-not $TargetDomain) { $keep = $false }
                    else { $keep = ($TargetDomain.ToLower() -eq $FilterDomainNormalized) }
                }

                if ($keep) {
                    $LockoutEvents += [PSCustomObject]@{
                        TimeCreated      = $Event.TimeCreated
                        User             = $User
                        TargetDomain     = $TargetDomain
                        CallerComputer   = $CallerComputer
                        TargetSid        = ($edata['TargetSid'] -as [string])
                        DomainController = $DC
                        RecordId         = $Event.RecordId
                    }
                }
            }
            catch {
                Write-Warning "Failed to parse event from $DC (RecordId: $($Event.RecordId)): $($_.Exception.Message)"
            }
        }
    }
    catch {
        Write-Warning "Failed to query $DC: $($_.Exception.Message)"
    }
}

# Output
if ($LockoutEvents.Count -eq 0) {
    Write-Host "‚úÖ No matching lockout events found in the past $HoursToLookBack hours for FilterUser='$FilterUser' FilterDomain='$FilterDomain'." -ForegroundColor Green
}
else {
    $LockoutEvents |
        Sort-Object TimeCreated -Descending |
        Tee-Object -Variable SortedResults |
        Format-Table TimeCreated, User, TargetDomain, CallerComputer, DomainController -AutoSize

    try {
        $SortedResults | Export-Csv -Path $OutputCSV -NoTypeInformation -Force
        Write-Host "`nüìÅ Report exported to: $OutputCSV" -ForegroundColor Cyan
    }
    catch {
        Write-Error "Failed to export CSV to '$OutputCSV': $($_.Exception.Message)"
    }
}
